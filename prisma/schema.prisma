generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
}

enum OrderStatus {
  pending
  approved
  rejected
  in_process
  unknown
}

model Product {
  id           String          @id @default(uuid()) @db.Uuid
  slug         String          @unique
  name         String
  basePrice    Decimal         @db.Decimal(12, 2)
  category     String?
  description  String?
  rating       Decimal?        @db.Decimal(3, 1)
  reviewsCount Int             @default(0)
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  images       ProductImage[]
  options      ProductOption[]
  skus         ProductSku[]
  bundles      ProductBundle[] @relation("ProductBundleProduct")
  bundledBy    ProductBundle[] @relation("ProductBundleRelated")
  orderItems   OrderItem[]
}

model ProductImage {
  id         BigInt   @id @default(autoincrement())
  productId  String   @db.Uuid
  url        String
  position   Int      @default(0)
  isPrimary  Boolean  @default(false)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductOption {
  id         BigInt               @id @default(autoincrement())
  productId  String               @db.Uuid
  name       String
  position   Int                  @default(0)
  product    Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  values     ProductOptionValue[]

  @@unique([productId, name])
}

model ProductOptionValue {
  id        BigInt        @id @default(autoincrement())
  optionId  BigInt
  value     String
  position  Int           @default(0)
  option    ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  skuLinks  ProductSkuOption[]

  @@unique([optionId, value])
}

model ProductSku {
  id        String             @id @default(uuid()) @db.Uuid
  productId String             @db.Uuid
  skuCode   String?            @unique
  price     Decimal            @db.Decimal(12, 2)
  stock     Int                @default(0)
  isActive  Boolean            @default(true)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  product   Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  options   ProductSkuOption[]
  orderItem OrderItem[]
}

model ProductSkuOption {
  skuId         String              @db.Uuid
  optionValueId BigInt
  sku           ProductSku          @relation(fields: [skuId], references: [id], onDelete: Cascade)
  optionValue   ProductOptionValue  @relation(fields: [optionValueId], references: [id], onDelete: Cascade)

  @@id([skuId, optionValueId])
}

model ProductBundle {
  productId        String  @db.Uuid
  relatedProductId String  @db.Uuid
  product          Product @relation("ProductBundleProduct", fields: [productId], references: [id], onDelete: Cascade)
  relatedProduct   Product @relation("ProductBundleRelated", fields: [relatedProductId], references: [id], onDelete: Cascade)

  @@id([productId, relatedProductId])
}

model Order {
  id             String        @id @default(uuid()) @db.Uuid
  externalRef    String?
  mpPreferenceId String?       @unique
  mpPaymentId    String?       @unique
  status         OrderStatus   @default(pending)
  subtotal       Decimal       @db.Decimal(12, 2)
  discount       Decimal       @default(0) @db.Decimal(12, 2)
  shipping       Decimal       @default(0) @db.Decimal(12, 2)
  total          Decimal       @db.Decimal(12, 2)
  currency       String        @default("MXN")
  billingName    String?
  billingEmail   String?
  billingPhone   String?
  shippingAddr   Json?
  notes          String?
  invoice        Json?
  raw            Json?
  
  // Campos para finanzas
  paymentFee     Decimal       @default(0) @db.Decimal(12, 2)   // Comisión de pasarela
  shippingCost   Decimal       @default(0) @db.Decimal(12, 2)   // Costo real del envío (lo que te cobra paquetería)
  packagingCost  Decimal       @default(0) @db.Decimal(12, 2)   // Costo de empaque
  refundAmount   Decimal       @default(0) @db.Decimal(12, 2)   // Monto reembolsado
  refundStatus   String?                                        // "none", "pending", "processed"
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  items          OrderItem[]
  payment        Payment?
  shipment       Shipment?
  auditLogs      AuditLog[]
}

model OrderItem {
  id            BigInt     @id @default(autoincrement())
  orderId       String     @db.Uuid
  productId     String?    @db.Uuid
  skuId         String?    @db.Uuid
  slugSnapshot  String
  nameSnapshot  String
  priceSnapshot Decimal    @db.Decimal(12, 2)
  quantity      Int
  order         Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product?   @relation(fields: [productId], references: [id])
  sku           ProductSku?@relation(fields: [skuId], references: [id])
}

model Payment {
  id         BigInt   @id @default(autoincrement())
  orderId    String   @unique @db.Uuid
  provider   String
  status     String
  raw        Json?
  receivedAt DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Shipment {
  id         BigInt   @id @default(autoincrement())
  orderId    String   @unique @db.Uuid
  status     String   @default("pending")
  tracking   String?
  carrier    String?
  metadata   Json?
  updatedAt  DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model WebhookEvent {
  id         BigInt   @id @default(autoincrement())
  provider   String
  externalId String
  status     String
  payload    Json
  receivedAt DateTime @default(now())

  @@unique([provider, externalId])
}

model AdminUser {
  id           String     @id @default(uuid()) @db.Uuid
  email        String     @unique
  passwordHash String
  role         String     @default("admin")
  createdAt    DateTime   @default(now())
  auditLogs    AuditLog[]
}

model AuditLog {
  id        BigInt     @id @default(autoincrement())
  actorId   String?    @db.Uuid
  orderId   String?    @db.Uuid
  action    String
  entity    String
  entityId  String?
  data      Json?
  createdAt DateTime   @default(now())
  actor     AdminUser? @relation(fields: [actorId], references: [id])
  order     Order?     @relation(fields: [orderId], references: [id])
}

// Ventas físicas/manuales (tickets de tienda física)
model Sale {
  id            String   @id @default(uuid()) @db.Uuid
  name          String                        // Nombre/descripción del producto vendido
  quantity      Int                           // Cantidad de unidades
  costUnit      Decimal  @db.Decimal(12, 2)   // Costo unitario de adquisición
  priceUnit     Decimal  @db.Decimal(12, 2)   // Precio de venta unitario
  date          DateTime                      // Fecha de la venta
  note          String?                       // Nota opcional
  
  // Campos para finanzas
  paymentFee    Decimal  @default(0) @db.Decimal(12, 2)   // Comisión de pasarela de pago
  shippingCost  Decimal  @default(0) @db.Decimal(12, 2)   // Costo de envío
  packagingCost Decimal  @default(0) @db.Decimal(12, 2)   // Costo de empaque
  discount      Decimal  @default(0) @db.Decimal(12, 2)   // Descuento aplicado
  channel       String   @default("physical")             // Canal: "physical", "online"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
